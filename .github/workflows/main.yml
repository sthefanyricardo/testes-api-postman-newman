name: Run the test collection of the Serve REST API with newman

on:
  push:
    branches:
      - main
  # Permite execuÃ§Ã£o manual via Actions > Workflows > Run workflow
  workflow_dispatch:
    inputs:
      ref:
        description: 'Branch ou Tag para execuÃ§Ã£o (deixe vazio para usar a referÃªncia padrÃ£o)'
        required: false
        default: 'main'
        
jobs:
  # Job 1: Executar os testes com Newman
  run-job-newman:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read

    steps:
    
      - uses: actions/checkout@v5

      - name: Prepare reports dir
        run: mkdir -p newman_test_artifacts

      # Configure Node.js environment
      - name: Install Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24.11.1'

      # Install Newman and reporters
      - name: Install Newman and reporters
        run: |
          npm install -g newman
          npm install -g newman-reporter-htmlextra
          # Se for usar outros reporters, instale-os a partir daqui:
          npm install -g newman-reporter-csv
          npm install -g newman-reporter-html

      - name: Run Newman - Serve Rest ADM
        id: run_newman_adm
        continue-on-error: true
        run: |
          newman run collections/serve_rest_adm.postman_collection.json \
            -e environment/serve_rest.postman_environment.json \
            -r cli,htmlextra,html,csv,json \
            --reporter-htmlextra-export newman_test_artifacts/report-adm-htmlextra.html \
            --reporter-html-export newman_test_artifacts/report-adm-html.html \
            --reporter-csv-export newman_test_artifacts/report-adm.csv --reporter-csv-includeBody \
            --reporter-json-export newman_test_artifacts/report-adm.json

      - name: Run Newman - Serve Rest User
        id: run_newman_user
        continue-on-error: true
        run: |
          newman run collections/serve_rest_user.postman_collection.json \
            -e environment/serve_rest.postman_environment.json \
            -r cli,htmlextra,html,csv,json \
            --reporter-htmlextra-export newman_test_artifacts/report-user-htmlextra.html \
            --reporter-html-export newman_test_artifacts/report-user-html.html \
            --reporter-csv-export newman_test_artifacts/report-user.csv --reporter-csv-includeBody \
            --reporter-json-export newman_test_artifacts/report-user.json

      - name: Create index.html for GitHub Pages
        if: always()
        run: |
          cat > newman_test_artifacts/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="pt-BR">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Newman Test Reports</title>
            <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
              }
              .container {
                background: white;
                border-radius: 16px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                padding: 40px;
                max-width: 800px;
                width: 100%;
              }
              h1 {
                color: #333;
                margin-bottom: 10px;
                font-size: 2.5em;
              }
              .subtitle {
                color: #666;
                margin-bottom: 40px;
                font-size: 1.1em;
              }
              .section {
                margin-bottom: 30px;
              }
              .section h2 {
                color: #667eea;
                margin-bottom: 15px;
                font-size: 1.5em;
                border-bottom: 2px solid #667eea;
                padding-bottom: 10px;
              }
              .links {
                display: grid;
                gap: 10px;
              }
              a {
                display: block;
                padding: 15px 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                text-decoration: none;
                border-radius: 8px;
                transition: transform 0.2s, box-shadow 0.2s;
                font-weight: 500;
              }
              a:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
              }
              .timestamp {
                text-align: center;
                color: #999;
                margin-top: 30px;
                font-size: 0.9em;
              }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>ğŸ“Š Newman Test Reports</h1>
              <p class="subtitle">RelatÃ³rios de Testes da API Serve REST</p>
              
              <div class="section">
                <h2>ğŸ” Admin Reports</h2>
                <div class="links">
                  <a href="report-adm-htmlextra.html">ğŸ“ˆ Report Admin (HTML Extra)</a>
                  <a href="report-adm-html.html">ğŸ“„ Report Admin (HTML)</a>
                  <a href="report-adm.csv">ğŸ“Š Report Admin (CSV)</a>
                  <a href="report-adm.json">ğŸ”§ Report Admin (JSON)</a>
                </div>
              </div>
              
              <div class="section">
                <h2>ğŸ‘¤ User Reports</h2>
                <div class="links">
                  <a href="report-user-htmlextra.html">ğŸ“ˆ Report User (HTML Extra)</a>
                  <a href="report-user-html.html">ğŸ“„ Report User (HTML)</a>
                  <a href="report-user.csv">ğŸ“Š Report User (CSV)</a>
                  <a href="report-user.json">ğŸ”§ Report User (JSON)</a>
                </div>
              </div>
              
              <div class="timestamp">
                ğŸ•’ Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
              </div>
            </div>
          </body>
          </html>
          EOF
          
      - name: Upload Report Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Reports
          path: newman_test_artifacts

# Job 2: Deploy para GitHub Pages
  deploy-github-pages:
    # Este job sÃ³ executa se o job 'newman' for bem-sucedido
    needs: run-job-newman
    
    runs-on: ubuntu-latest
    
    # PermissÃµes necessÃ¡rias para deploy no GitHub Pages
    permissions:
      contents: read
      pages: write
      id-token: write
      
    # Deploy to the github-pages environment
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
  
    steps:
    
      # Download do artefato gerado pelo job anterior
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: Reports
          path: newman_test_artifacts

      # Upload para GitHub Pages
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: newman_test_artifacts
    
      # Deploy no GitHub Pages
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      # Mostrar a URL nos logs
      - name: Show GitHub Pages URL
        run: |
          echo "GitHub Pages URL: ${{ steps.deployment.outputs.page_url }}"
